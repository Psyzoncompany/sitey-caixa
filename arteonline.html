<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Revisão da Arte</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="cliente-page">
  <main class="cliente-wrap">
    <section id="cliente-loading" class="glass-card artx-glass-card p-8">
      <div class="cliente-skeleton-title"></div><div class="cliente-skeleton-line"></div><div class="cliente-skeleton-preview"></div>
    </section>
    <section id="invalid-link" class="glass-card artx-glass-card p-8 text-center hidden">
      <h1 class="text-2xl font-bold mb-2">Link inválido</h1>
      <p class="text-gray-300">Esse link não é válido ou expirou.</p>
    </section>

    <section id="cliente-app" class="hidden">
      <header class="glass-card artx-glass-card cliente-header">
        <div>
          <h1 id="order-title" class="text-2xl font-bold">Pedido</h1>
          <p id="order-subtitle" class="text-sm text-gray-300">Carregando...</p>
        </div>
        <span id="order-status" class="artx-badge-pill">Pendente</span>
      </header>

      <article class="glass-card artx-glass-card cliente-preview-card">
        <img id="active-preview" alt="Prévia ativa" />
      </article>

      <article class="glass-card artx-glass-card p-4">
        <h2 class="font-semibold mb-2">Histórico de versões</h2>
        <div id="versions-list" class="cliente-versions-list"></div>
      </article>

      <article class="glass-card artx-glass-card p-4">
        <h2 class="font-semibold mb-3">Feedback</h2>
        <div class="cliente-chip-row" id="quick-chips"></div>
        <textarea id="feedback-message" rows="5" class="artx-input-text" placeholder="Descreva as alterações..."></textarea>
        <div class="mt-3">
          <input id="feedback-images" type="file" accept="image/jpeg,image/png,image/webp" multiple class="hidden" />
          <button id="btn-pick-images" class="artx-btn-soft" type="button">Enviar imagens</button>
          <small class="block text-xs text-gray-400 mt-1">Até 5 imagens · máx 5MB cada</small>
          <div id="upload-preview" class="cliente-upload-grid"></div>
          <div class="cliente-progress"><span id="upload-progress"></span></div>
        </div>
        <div class="cliente-actions">
          <button id="btn-send-feedback" class="btn-shine py-3 px-5 rounded-xl">Enviar Ajustes</button>
          <button id="btn-approve" class="artx-btn-soft">Aprovar esta versão</button>
        </div>
      </article>
    </section>
  </main>

  <script type="module">
    import { doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
    import { db, storage } from "./js/firebase-init.js";

    const params = new URLSearchParams(location.search);
    const token = params.get('token');

    const quickTexts = ['Trocar cor', 'Aumentar logo', 'Diminuir texto', 'Reposicionar elementos', 'Outro'];
    const el = (id) => document.getElementById(id);
    const state = { order: null, selectedVersionId: null, files: [], oid: null };

    function statusLabel(status) {
      return ({ draft:'Rascunho', sent:'Enviada', changes_requested:'Ajustes solicitados', approved:'Aprovada', done:'Finalizado', pending:'Pendente' })[status] || status;
    }

    function getActiveVersion(order) {
      const versions = Array.isArray(order?.artControl?.versions) ? order.artControl.versions : [];
      return versions.find((v) => v.id === state.selectedVersionId)
        || versions.find((v) => v.id === order?.art?.activeVersionId)
        || versions[versions.length - 1]
        || null;
    }

    function render() {
      const order = state.order;
      const active = getActiveVersion(order);
      el('order-title').textContent = order.description || `Pedido #${order.id}`;
      el('order-subtitle').textContent = `Pedido ${order.id}`;
      const currentStatus = order?.art?.status || active?.status || 'pending';
      el('order-status').textContent = statusLabel(currentStatus);
      const isDone = currentStatus === 'done';
      el('btn-send-feedback').disabled = isDone;
      el('btn-approve').disabled = isDone;

      const preview = el('active-preview');
      preview.src = active?.previewUrl || active?.images?.[0] || '';
      preview.style.display = preview.src ? 'block' : 'none';

      const list = el('versions-list');
      list.innerHTML = '';
      const versions = [...(order?.artControl?.versions || [])].sort((a,b)=>(b.versionNumber||b.version)-(a.versionNumber||a.version));
      versions.forEach((ver) => {
        const item = document.createElement('button');
        item.type = 'button';
        item.className = 'cliente-version-item';
        item.innerHTML = `<img src="${ver.previewUrl || ver.images?.[0] || ''}" alt="v${ver.versionNumber}"><span>Versão ${ver.versionNumber}</span><small>${statusLabel(ver.status)}</small>`;
        item.onclick = () => { state.selectedVersionId = ver.id; render(); };
        list.appendChild(item);
      });
    }

    function mountChips() {
      const row = el('quick-chips');
      row.innerHTML = '';
      quickTexts.forEach((txt) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'artx-btn-soft';
        btn.textContent = txt;
        btn.onclick = () => {
          const t = el('feedback-message');
          t.value = t.value ? `${t.value} | ${txt}` : txt;
        };
        row.appendChild(btn);
      });
    }

    async function compressImage(file) {
      const bitmap = await createImageBitmap(file);
      const maxW = 1600;
      const ratio = Math.min(1, maxW / bitmap.width);
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(bitmap.width * ratio);
      canvas.height = Math.round(bitmap.height * ratio);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
      const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', 0.84));
      return new File([blob], file.name.replace(/\.[^.]+$/, '.jpg'), { type: 'image/jpeg' });
    }

    function renderUploadPreview() {
      const box = el('upload-preview');
      box.innerHTML = '';
      state.files.forEach((file, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'cliente-upload-item';
        wrap.innerHTML = `<img src="${URL.createObjectURL(file)}" alt="upload-${idx}"><button type="button" aria-label="Remover imagem"><svg class="syt-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 6l12 12M18 6L6 18"/></svg></button>`;
        wrap.querySelector('button').onclick = () => { state.files.splice(idx, 1); renderUploadPreview(); };
        box.appendChild(wrap);
      });
    }

    async function uploadSelectedImages(versionId) {
      if (!state.files.length) return [];
      const uploads = [];
      let uploadedCount = 0;
      for (const file of state.files) {
        const compressed = await compressImage(file);
        const path = `art-feedback/${state.oid}/${versionId}/${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;
        const task = uploadBytesResumable(ref(storage, path), compressed);
        const url = await new Promise((resolve, reject) => {
          task.on('state_changed', (snap) => {
            const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
            el('upload-progress').style.width = `${Math.min(100, Math.round(((uploadedCount + pct / 100) / state.files.length) * 100))}%`;
          }, reject, async () => {
            uploadedCount += 1;
            resolve(await getDownloadURL(task.snapshot.ref));
          });
        });
        uploads.push({ url, name: file.name, uploadedAt: Date.now() });
      }
      return uploads;
    }

    async function sendClientEvent(type) {
      const active = getActiveVersion(state.order);
      if (!active) return alert('Sem versão ativa.');

      const msg = el('feedback-message').value.trim();
      if (type === 'changes_requested' && !msg) return alert('Escreva o feedback antes de enviar.');

      const images = await uploadSelectedImages(active.id || 'v1');
      const payload = {
        type,
        token,
        oid: state.oid,
        versionId: active.id || null,
        versionNumber: active.versionNumber || active.version || null,
        message: msg,
        images,
        createdAtClient: Date.now()
      };

      await addDoc(collection(db, `orders/${state.oid}/clientFeedback`), {
        ...payload,
        createdAt: serverTimestamp()
      });
      await addDoc(collection(db, 'order_feedback', token, 'events'), {
        ...payload,
        createdAt: serverTimestamp()
      });

      alert(type === 'approved' ? 'Versão aprovada com sucesso.' : 'Recebido!');
      location.reload();
    }

    async function load() {
      if (!token) {
        el('cliente-loading').classList.add('hidden');
        el('invalid-link').classList.remove('hidden');
        return;
      }

      const bridgeSnap = await getDoc(doc(db, 'order_clients', token));
      if (!bridgeSnap.exists()) {
        el('cliente-loading').classList.add('hidden');
        el('invalid-link').classList.remove('hidden');
        return;
      }

      state.oid = String((bridgeSnap.data() || {}).oid || '');
      if (!state.oid) {
        el('cliente-loading').classList.add('hidden');
        el('invalid-link').classList.remove('hidden');
        return;
      }

      const orderSnap = await getDoc(doc(db, 'orders', state.oid));
      if (!orderSnap.exists()) {
        el('cliente-loading').classList.add('hidden');
        el('invalid-link').classList.remove('hidden');
        return;
      }

      const found = orderSnap.data() || {};
      found.id = found.id || state.oid;
      found.art = found.art || {};
      found.artControl = found.artControl || { versions: [] };
      found.artControl.versions = Array.isArray(found.artControl.versions) ? found.artControl.versions : [];
      state.order = found;

      mountChips();
      render();
      el('cliente-loading').classList.add('hidden');
      el('cliente-app').classList.remove('hidden');

      el('btn-pick-images').onclick = () => el('feedback-images').click();
      el('feedback-images').onchange = (event) => {
        const files = [...(event.target.files || [])];
        const valid = files.filter((f) => /image\/(jpeg|png|webp)/.test(f.type) && f.size <= 5 * 1024 * 1024);
        state.files = [...state.files, ...valid].slice(0, 5);
        renderUploadPreview();
      };
      el('btn-send-feedback').onclick = () => sendClientEvent('changes_requested').catch((e) => { console.error(e); alert('Falha ao enviar feedback.'); });
      el('btn-approve').onclick = () => sendClientEvent('approved').catch((e) => { console.error(e); alert('Falha ao aprovar versão.'); });
    }

    load().catch((e) => {
      console.error(e);
      el('cliente-loading').classList.add('hidden');
      el('invalid-link').classList.remove('hidden');
    });
  </script>
</body>
</html>
