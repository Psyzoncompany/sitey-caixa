<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Revisão da Arte</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="cliente-page">
  <main class="cliente-wrap">
    <section id="invalid-link" class="glass-card artx-glass-card p-8 text-center hidden">
      <h1 class="text-2xl font-bold mb-2">Link inválido</h1>
      <p class="text-gray-300">Esse link não é válido ou expirou.</p>
    </section>

    <section id="cliente-app" class="hidden">
      <header class="glass-card artx-glass-card cliente-header">
        <div>
          <h1 id="order-title" class="text-2xl font-bold">Pedido</h1>
          <p id="order-subtitle" class="text-sm text-gray-300">Carregando...</p>
        </div>
        <span id="order-status" class="artx-badge-pill">Pendente</span>
      </header>

      <article class="glass-card artx-glass-card cliente-preview-card">
        <img id="active-preview" alt="Prévia ativa" />
      </article>

      <article class="glass-card artx-glass-card p-4">
        <h2 class="font-semibold mb-2">Histórico de versões</h2>
        <div id="versions-list" class="cliente-versions-list"></div>
      </article>

      <article class="glass-card artx-glass-card p-4">
        <h2 class="font-semibold mb-3">Feedback</h2>
        <div class="cliente-chip-row" id="quick-chips"></div>
        <textarea id="feedback-message" rows="5" class="artx-input-text" placeholder="Descreva as alterações..."></textarea>
        <div class="mt-3">
          <input id="feedback-images" type="file" accept="image/jpeg,image/png,image/webp" multiple class="hidden" />
          <button id="btn-pick-images" class="artx-btn-soft" type="button">Enviar imagens</button>
          <small class="block text-xs text-gray-400 mt-1">Até 5 imagens · máx 5MB cada</small>
          <div id="upload-preview" class="cliente-upload-grid"></div>
          <div class="cliente-progress"><span id="upload-progress"></span></div>
        </div>
        <div class="cliente-actions">
          <button id="btn-send-feedback" class="btn-shine py-3 px-5 rounded-xl">Enviar Ajustes</button>
          <button id="btn-approve" class="artx-btn-soft">Aprovar esta versão</button>
        </div>
      </article>
    </section>
  </main>

  <script type="module">
    import { collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
    import { db, storage } from "./js/firebase-init.js";

    const params = new URLSearchParams(location.search);
    const oid = params.get('oid');
    const token = params.get('token');

    const quickTexts = ['Trocar cor', 'Aumentar logo', 'Diminuir texto', 'Reposicionar elementos', 'Outro'];
    const el = (id) => document.getElementById(id);
    const state = { userDocId: null, field: 'production_orders', ordersRawString: false, order: null, selectedVersionId: null, files: [] };

    function parseOrders(data) {
      if (Array.isArray(data.production_orders)) return { field: 'production_orders', orders: data.production_orders, rawString: false };
      if (typeof data.production_orders === 'string') {
        try { return { field: 'production_orders', orders: JSON.parse(data.production_orders), rawString: true }; } catch {}
      }
      if (Array.isArray(data.orders)) return { field: 'orders', orders: data.orders, rawString: false };
      if (typeof data.orders === 'string') {
        try { return { field: 'orders', orders: JSON.parse(data.orders), rawString: true }; } catch {}
      }
      return { field: 'production_orders', orders: [], rawString: false };
    }

    function ensureArt(order) {
      order.art = order.art || {};
      order.artControl = order.artControl || { versions: [] };
      order.artControl.versions = Array.isArray(order.artControl.versions) ? order.artControl.versions : [];
      order.art.activeVersionId = order.art.activeVersionId || order.artControl.versions[order.artControl.versions.length - 1]?.id || null;
      return order;
    }

    function statusLabel(status) {
      return ({ draft:'Rascunho', sent:'Enviada', changes_requested:'Ajustes solicitados', approved:'Aprovada', done:'Finalizado', pending:'Pendente' })[status] || status;
    }

    function getActiveVersion(order) {
      return order.artControl.versions.find((v) => v.id === state.selectedVersionId)
        || order.artControl.versions.find((v) => v.id === order.art.activeVersionId)
        || order.artControl.versions[order.artControl.versions.length - 1]
        || null;
    }

    function render() {
      const order = state.order;
      const active = getActiveVersion(order);
      el('order-title').textContent = order.description || `Pedido #${order.id}`;
      el('order-subtitle').textContent = `Pedido ${order.id}`;
      el('order-status').textContent = statusLabel(order.art.status || active?.status || 'pending');

      const preview = el('active-preview');
      preview.src = active?.previewUrl || active?.images?.[0] || '';
      preview.style.display = preview.src ? 'block' : 'none';

      const list = el('versions-list');
      list.innerHTML = '';
      [...order.artControl.versions].sort((a,b)=>(b.versionNumber||b.version)-(a.versionNumber||a.version)).forEach((ver) => {
        const item = document.createElement('button');
        item.type = 'button';
        item.className = 'cliente-version-item';
        item.innerHTML = `<img src="${ver.previewUrl || ver.images?.[0] || ''}" alt="v${ver.versionNumber}"><span>Versão ${ver.versionNumber}</span><small>${statusLabel(ver.status)}</small>`;
        item.onclick = () => { state.selectedVersionId = ver.id; render(); };
        list.appendChild(item);
      });
    }

    function mountChips() {
      const host = el('quick-chips');
      quickTexts.forEach((text) => {
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'artx-chip';
        chip.textContent = text;
        chip.onclick = () => {
          const area = el('feedback-message');
          area.value = area.value ? `${area.value}\n${text}` : text;
          area.focus();
        };
        host.appendChild(chip);
      });
    }

    async function compressImage(file) {
      const bitmap = await createImageBitmap(file);
      const maxW = 1600;
      const ratio = Math.min(1, maxW / bitmap.width);
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(bitmap.width * ratio);
      canvas.height = Math.round(bitmap.height * ratio);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
      const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', 0.84));
      return new File([blob], file.name.replace(/\.[^.]+$/, '.jpg'), { type: 'image/jpeg' });
    }

    function renderUploadPreview() {
      const box = el('upload-preview');
      box.innerHTML = '';
      state.files.forEach((file, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'cliente-upload-item';
        wrap.innerHTML = `<img src="${URL.createObjectURL(file)}" alt="upload-${idx}"><button type="button">✕</button>`;
        wrap.querySelector('button').onclick = () => { state.files.splice(idx, 1); renderUploadPreview(); };
        box.appendChild(wrap);
      });
    }

    async function uploadSelectedImages(orderId, versionId) {
      if (!state.files.length) return [];
      const uploads = [];
      let uploadedCount = 0;
      for (const file of state.files) {
        const compressed = await compressImage(file);
        const path = `art-feedback/${orderId}/${versionId}/${Date.now()}-${Math.random().toString(36).slice(2)}.jpg`;
        const task = uploadBytesResumable(ref(storage, path), compressed);
        const url = await new Promise((resolve, reject) => {
          task.on('state_changed', (snap) => {
            const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
            el('upload-progress').style.width = `${Math.min(100, Math.round(((uploadedCount + pct / 100) / state.files.length) * 100))}%`;
          }, reject, async () => {
            uploadedCount += 1;
            resolve(await getDownloadURL(task.snapshot.ref));
          });
        });
        uploads.push({ url, name: file.name, uploadedAt: Date.now() });
      }
      return uploads;
    }

    async function persistOrder() {
      const snap = await getDocs(collection(db, 'users'));
      for (const userDoc of snap.docs) {
        const parsed = parseOrders(userDoc.data());
        const index = parsed.orders.findIndex((o) => String(o.id) === String(oid) && (o?.art?.clientToken || o?.clientToken) === token);
        if (index >= 0) {
          const updated = [...parsed.orders];
          updated[index] = state.order;
          await updateDoc(doc(db, 'users', userDoc.id), { [parsed.field]: parsed.rawString ? JSON.stringify(updated) : updated });
          return;
        }
      }
      throw new Error('Pedido não encontrado para atualizar.');
    }

    async function sendFeedback() {
      const msg = el('feedback-message').value.trim();
      if (!msg) return alert('Escreva o feedback antes de enviar.');
      const active = getActiveVersion(state.order);
      if (!active) return alert('Sem versão ativa.');

      const images = await uploadSelectedImages(state.order.id, active.id);
      active.clientFeedback = { message: msg, images, createdAt: Date.now() };
      active.status = 'changes_requested';
      active.history = Array.isArray(active.history) ? active.history : [];
      active.history.push({ action: 'changes_requested', date: Date.now(), user: 'Cliente', comment: msg });
      state.order.art.status = 'changes_requested';
      state.order.art.lastClientActivity = { type: 'changes_requested', at: Date.now() };
      await persistOrder();
      alert('Recebido!');
      location.reload();
    }

    async function approveVersion() {
      const active = getActiveVersion(state.order);
      if (!active) return;
      active.status = 'approved';
      active.history = Array.isArray(active.history) ? active.history : [];
      active.history.push({ action: 'approved', date: Date.now(), user: 'Cliente', comment: 'Aprovado pelo cliente' });
      state.order.art.status = 'approved';
      state.order.art.lastClientActivity = { type: 'approved', at: Date.now() };
      await persistOrder();
      alert('Versão aprovada com sucesso.');
      location.reload();
    }

    async function load() {
      if (!oid || !token) {
        el('invalid-link').classList.remove('hidden');
        return;
      }
      const snap = await getDocs(collection(db, 'users'));
      let found = null;
      for (const userDoc of snap.docs) {
        const parsed = parseOrders(userDoc.data());
        const order = parsed.orders.find((o) => String(o.id) === String(oid) && (o?.art?.clientToken || o?.clientToken) === token);
        if (order) {
          found = ensureArt(order);
          state.userDocId = userDoc.id;
          state.field = parsed.field;
          state.ordersRawString = parsed.rawString;
          break;
        }
      }

      if (!found) {
        el('invalid-link').classList.remove('hidden');
        return;
      }

      state.order = found;
      mountChips();
      render();
      el('cliente-app').classList.remove('hidden');

      el('btn-pick-images').onclick = () => el('feedback-images').click();
      el('feedback-images').onchange = (event) => {
        const files = [...(event.target.files || [])];
        const valid = files.filter((f) => /image\/(jpeg|png|webp)/.test(f.type) && f.size <= 5 * 1024 * 1024);
        state.files = [...state.files, ...valid].slice(0, 5);
        renderUploadPreview();
      };
      el('btn-send-feedback').onclick = () => sendFeedback().catch((e) => { console.error(e); alert('Falha ao enviar feedback.'); });
      el('btn-approve').onclick = () => approveVersion().catch((e) => { console.error(e); alert('Falha ao aprovar versão.'); });
    }

    load().catch((e) => {
      console.error(e);
      el('invalid-link').classList.remove('hidden');
    });
  </script>
</body>
</html>
