<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PSYZON AI</title>
  <link rel="icon" type="image/png" href="img/logo.png">
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, sans-serif;
      background: #0d0d1a;
      color: #e2e8f0;
      min-height: 100vh;
    }
    .app { display: flex; min-height: 100vh; }
    .menu-btn {
      position: fixed; top: 14px; left: 14px; z-index: 40;
      background: rgba(30,41,59,.9); border: 1px solid rgba(148,163,184,.25);
      color: #e2e8f0; border-radius: 10px; padding: 8px 10px; display: none;
    }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 20; display: none; }
    .sidebar {
      width: 260px; background: #1a1a2e; border-right: 1px solid rgba(148,163,184,.2);
      padding: 18px 12px; display: flex; flex-direction: column; gap: 14px;
      position: relative; z-index: 30;
    }
    .logo { font-weight: 800; font-size: 1.2rem; background: linear-gradient(135deg,#22d3ee,#a78bfa); -webkit-background-clip: text; color: transparent; }
    .new-btn {
      border: 1px solid rgba(34,211,238,.35); background: rgba(34,211,238,.1);
      color: #67e8f9; border-radius: 10px; padding: 10px; cursor: pointer; font-weight: 700;
    }
    .user-name { font-size: .8rem; color: #94a3b8; }
    .group-title { font-size: .75rem; color: #64748b; text-transform: uppercase; margin: 10px 6px 4px; }
    .conv-item {
      padding: 10px; border-radius: 10px; color: #cbd5e1; cursor: pointer; border: 1px solid transparent;
      display: flex; justify-content: space-between; align-items: center; gap: 6px;
    }
    .conv-item:hover { background: rgba(148,163,184,.08); border-color: rgba(148,163,184,.2); }
    .conv-item.active { background: rgba(139,92,246,.16); border-color: rgba(167,139,250,.5); }
    .del-btn { opacity: 0; border: none; background: transparent; color: #fca5a5; cursor: pointer; }
    .conv-item:hover .del-btn { opacity: 1; }
    .main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 24px; border-bottom: 1px solid rgba(148,163,184,.15);
      position: sticky; top: 0; background: rgba(13,13,26,.95); backdrop-filter: blur(8px); z-index: 10;
    }
    .header-title { font-weight: 700; }
    .header-actions button {
      border: 1px solid rgba(148,163,184,.25); background: rgba(30,41,59,.8); color:#cbd5e1;
      border-radius: 10px; padding: 8px 10px; margin-left: 8px; cursor: pointer;
    }
    .messages { flex: 1; overflow-y: auto; padding: 26px 16px 210px; }
    .messages-inner { max-width: 720px; margin: 0 auto; display: flex; flex-direction: column; gap: 18px; }
    .msg { display: flex; gap: 10px; }
    .avatar {
      width: 30px; height: 30px; border-radius: 50%; display: grid; place-items: center; font-size: .8rem; font-weight: 700;
      flex-shrink: 0;
    }
    .avatar.ai { background: linear-gradient(135deg,#22d3ee,#8b5cf6); color: white; }
    .avatar.user { background: #7c3aed; color: white; }
    .bubble { font-size: 15px; line-height: 1.7; }
    .msg.user .bubble { background: rgba(139,92,246,0.12); border: 1px solid rgba(167,139,250,.3); padding: 10px 12px; border-radius: 12px; }
    .msg.ai .bubble { padding-top: 5px; }
    .composer {
      position: fixed; bottom: 0; left: 260px; right: 0;
      background: rgba(13,13,26,.96); border-top: 1px solid rgba(148,163,184,.15); padding: 14px 16px calc(14px + env(safe-area-inset-bottom)); z-index: 15;
    }
    .composer-inner { max-width: 720px; margin: 0 auto; }
    .modes { display: flex; gap: 8px; margin-bottom: 10px; }
    .mode { border: 1px solid rgba(148,163,184,.25); background: rgba(30,41,59,.7); color: #94a3b8; border-radius: 8px; padding: 6px 10px; cursor: pointer; }
    .mode.active { color: #e2e8f0; border-color: #22d3ee; }
    .input-row { display: flex; gap: 8px; align-items: center; }
    input[type="text"] {
      flex: 1; background: rgba(30,41,59,.85); border: 1px solid rgba(148,163,184,.25); color: #fff;
      padding: 12px; border-radius: 12px; font-size: 15px;
    }
    .image-btn {
      background: rgba(30,41,59,0.8);
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: 12px;
      color: #64748b;
      cursor: pointer;
      padding: 9px 10px;
      display: flex;
      align-items: center;
      transition: all 0.15s ease;
    }
    .image-btn:hover { color: #22d3ee; border-color: rgba(6,182,212,0.4); }
    .send-btn { border: none; border-radius: 12px; padding: 12px 14px; background: linear-gradient(135deg,#06b6d4,#8b5cf6); color: white; cursor: pointer; }
    .preview { width: 80px; height: 80px; object-fit: cover; border-radius: 10px; border: 1px solid rgba(148,163,184,.3); margin-bottom: 8px; }
    @media (max-width: 900px) {
      .menu-btn { display: block; }
      .sidebar { position: fixed; left: -270px; top: 0; bottom: 0; transition: left .2s; }
      .sidebar.open { left: 0; }
      .overlay.open { display: block; }
      .composer { left: 0; }
      .header { padding-left: 56px; }
    }
  </style>
</head>
<body>
  <button class="menu-btn" id="menu-btn">â˜°</button>
  <div class="overlay" id="overlay"></div>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="logo">PSYZON AI</div>
      <button class="new-btn" id="new-chat">ï¼‹ Nova conversa</button>
      <div class="user-name" id="user-name">UsuÃ¡rio</div>
      <div id="conversation-list"></div>
    </aside>
    <main class="main">
      <header class="header">
        <div class="header-title" id="chat-title">Nova conversa</div>
        <div class="header-actions">
          <button id="export-chat">Exportar</button>
          <button id="clear-chat">Limpar</button>
        </div>
      </header>
      <section class="messages"><div class="messages-inner" id="messages"></div></section>
    </main>
  </div>
  <div class="composer">
    <div class="composer-inner">
      <div class="modes" id="mode-selector">
        <button class="mode active" data-mode="normal">Normal</button>
        <button class="mode" data-mode="rapido">RÃ¡pido</button>
        <button class="mode" data-mode="profundo">Profundo</button>
      </div>
      <img id="preview" class="preview" style="display:none;" alt="preview" />
      <div class="input-row">
        <button class="image-btn" id="image-btn">ðŸ“Ž</button>
        <input id="file-input" type="file" accept="image/*" hidden>
        <input id="chat-input" type="text" placeholder="Pergunte ao PSYZON AI...">
        <button id="send-btn" class="send-btn">Enviar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth } from './js/firebase-init.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

    const STORAGE_KEY = 'psyzon_conversations';
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const menuBtn = document.getElementById('menu-btn');
    const list = document.getElementById('conversation-list');
    const messagesEl = document.getElementById('messages');
    const input = document.getElementById('chat-input');
    const preview = document.getElementById('preview');
    const fileInput = document.getElementById('file-input');
    let mode = 'normal';
    let pendingImage = null;

    let conversations = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    let currentId = conversations[0]?.id || null;

    const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(conversations));
    const nowIso = () => new Date().toISOString();
    const findCurrent = () => conversations.find(c => c.id === currentId);

    const ensureConversation = () => {
      if (!findCurrent()) {
        const c = { id: crypto.randomUUID(), title: 'Nova conversa', messages: [], createdAt: nowIso(), updatedAt: nowIso() };
        conversations.unshift(c);
        currentId = c.id;
        save();
      }
    };

    const getGroup = (d) => {
      const date = new Date(d);
      const today = new Date();
      const startToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const startDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const diff = Math.floor((startToday - startDate) / 86400000);
      if (diff === 0) return 'Hoje';
      if (diff === 1) return 'Ontem';
      if (diff <= 7) return 'Esta semana';
      return 'Anteriores';
    };

    const renderList = () => {
      const groups = {};
      conversations.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt)).forEach(c => {
        const g = getGroup(c.updatedAt);
        groups[g] = groups[g] || [];
        groups[g].push(c);
      });
      list.innerHTML = '';
      Object.entries(groups).forEach(([group, items]) => {
        const h = document.createElement('div');
        h.className = 'group-title';
        h.textContent = group;
        list.appendChild(h);
        items.forEach(c => {
          const row = document.createElement('div');
          row.className = `conv-item ${c.id === currentId ? 'active' : ''}`;
          row.innerHTML = `<span>${c.title}</span><button class="del-btn" data-id="${c.id}">ðŸ—‘</button>`;
          row.onclick = () => { currentId = c.id; renderAll(); };
          row.querySelector('.del-btn').onclick = (e) => {
            e.stopPropagation();
            conversations = conversations.filter(item => item.id !== c.id);
            if (currentId === c.id) currentId = conversations[0]?.id || null;
            if (!currentId) ensureConversation();
            save();
            renderAll();
          };
          list.appendChild(row);
        });
      });
    };

    const getUserInitial = () => (document.getElementById('user-name').textContent || 'U').trim()[0]?.toUpperCase() || 'U';
    const renderMessages = () => {
      const c = findCurrent();
      messagesEl.innerHTML = '';
      document.getElementById('chat-title').textContent = c.title;
      c.messages.forEach(m => {
        const div = document.createElement('div');
        div.className = `msg ${m.role === 'assistant' ? 'ai' : 'user'}`;
        const avatar = m.role === 'assistant' ? '<div class="avatar ai">P</div>' : `<div class="avatar user">${getUserInitial()}</div>`;
        div.innerHTML = `${avatar}<div class="bubble">${(m.content || '').replace(/\n/g,'<br>')}</div>`;
        messagesEl.appendChild(div);
      });
      messagesEl.parentElement.scrollTop = messagesEl.parentElement.scrollHeight;
    };

    const renderAll = () => { ensureConversation(); renderList(); renderMessages(); };

    const send = async () => {
      if (!input.value.trim() && !pendingImage) return;
      const c = findCurrent();
      const userText = input.value.trim() || '[Imagem enviada]';
      c.messages.push({ role: 'user', content: userText });
      c.updatedAt = nowIso();
      if (c.title === 'Nova conversa' || !c.title) c.title = userText.slice(0, 40) || 'Nova conversa';
      const history = c.messages.slice(-20);
      const message = input.value.trim();
      input.value = '';
      renderAll();
      save();

      const response = await fetch('/api/chat', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message, mode, history, image: pendingImage })
      });
      const data = await response.json();
      c.messages.push({ role: 'assistant', content: data.content || data.error || 'Sem resposta.' });
      c.updatedAt = nowIso();
      save();
      renderAll();
      pendingImage = null;
      preview.style.display = 'none';
      fileInput.value = '';
    };

    document.getElementById('new-chat').onclick = () => {
      const c = { id: crypto.randomUUID(), title: 'Nova conversa', messages: [], createdAt: nowIso(), updatedAt: nowIso() };
      conversations.unshift(c); currentId = c.id; save(); renderAll();
    };
    document.getElementById('send-btn').onclick = send;
    input.addEventListener('keypress', (e) => { if (e.key === 'Enter') send(); });
    document.getElementById('image-btn').onclick = () => fileInput.click();
    fileInput.addEventListener('change', () => {
      const file = fileInput.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const result = String(reader.result || '');
        preview.src = result;
        preview.style.display = 'block';
        pendingImage = { base64: result.split(',')[1], mimeType: file.type || 'image/png' };
      };
      reader.readAsDataURL(file);
    });
    document.getElementById('clear-chat').onclick = () => {
      const c = findCurrent(); c.messages = []; c.updatedAt = nowIso(); save(); renderAll();
    };
    document.getElementById('export-chat').onclick = () => {
      const c = findCurrent();
      const text = c.messages.map(m => `${m.role === 'assistant' ? 'PSYZON AI' : 'VocÃª'}: ${m.content}`).join('\n');
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = `psyzon-ai-${c.id}.txt`; a.click();
      URL.revokeObjectURL(a.href);
    };
    document.getElementById('mode-selector').onclick = (e) => {
      const btn = e.target.closest('.mode');
      if (!btn) return;
      mode = btn.dataset.mode;
      document.querySelectorAll('.mode').forEach(m => m.classList.remove('active'));
      btn.classList.add('active');
    };

    menuBtn.onclick = () => { sidebar.classList.add('open'); overlay.classList.add('open'); };
    overlay.onclick = () => { sidebar.classList.remove('open'); overlay.classList.remove('open'); };

    onAuthStateChanged(auth, (user) => {
      document.getElementById('user-name').textContent = user?.displayName || user?.email || 'UsuÃ¡rio';
      renderAll();
    });
    renderAll();
  </script>
</body>
</html>
