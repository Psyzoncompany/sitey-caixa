<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat IA - Estilo Claude</title>
  <link rel="icon" type="image/png" href="img/logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            claude: {
              bg: '#fdfcf8',
              sidebar: '#ecece5',
              border: '#e1e1db',
              accent: '#da7756',
              text: '#2d2d2d',
              userMsg: '#f3f3ee'
            }
          },
          fontFamily: {
            sans: ['ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    html, body { overflow-x: hidden; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .typing-cursor::after { content: '▌'; animation: blink 1s step-start infinite; color: #da7756; }
    @keyframes blink { 50% { opacity: 0; } }
  </style>
</head>
<body class="bg-claude-bg text-claude-text min-h-screen h-[100dvh] flex overflow-hidden overflow-x-hidden font-sans selection:bg-claude-accent selection:text-white">
  <aside id="sidebar" class="w-64 bg-claude-sidebar border-r border-claude-border flex flex-col transition-all duration-300 absolute md:relative z-20 h-full -translate-x-full md:translate-x-0">
    <div class="p-4">
      <button id="new-chat" class="w-full flex items-center justify-between bg-transparent hover:bg-black/5 border border-claude-border px-3 py-2 rounded-lg transition-colors text-sm font-medium">
        <span class="flex items-center gap-2"><i class="fa-solid fa-plus text-claude-accent"></i> Novo Chat</span>
        <i class="fa-solid fa-pen-to-square text-gray-500"></i>
      </button>
    </div>

    <div class="flex-1 overflow-y-auto no-scrollbar px-3 space-y-1" id="conversation-list"></div>

    <div class="p-4 border-t border-claude-border space-y-2">
      <button id="go-dashboard" class="w-full flex items-center gap-3 hover:bg-black/5 p-2 rounded-lg transition-colors text-sm font-medium">
        <div class="w-8 h-8 rounded-full bg-white border border-claude-border text-claude-accent flex items-center justify-center"><i class="fa-solid fa-arrow-left"></i></div>
        <span>Voltar ao painel</span>
      </button>
      <button id="logout-btn" class="w-full flex items-center gap-3 hover:bg-black/5 p-2 rounded-lg transition-colors text-sm font-medium">
        <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-claude-accent to-orange-300 text-white flex items-center justify-center font-bold" id="user-initial">U</div>
        <span id="user-name">Usuário</span>
        <i class="fa-solid fa-right-from-bracket ml-auto text-gray-500"></i>
      </button>
    </div>
  </aside>

  <div id="sidebar-overlay" class="fixed inset-0 bg-black/20 z-10 hidden md:hidden"></div>

  <main class="flex-1 flex flex-col h-full relative w-full min-w-0 overflow-x-hidden">
    <header class="h-14 flex items-center justify-between px-4 border-b border-claude-border/50 bg-claude-bg/90 backdrop-blur-sm z-10 sticky top-0">
      <div class="flex items-center gap-3">
        <button id="toggle-sidebar" class="md:hidden p-2 text-gray-600 hover:bg-gray-100 rounded-md">
          <i class="fa-solid fa-bars"></i>
        </button>
        <button class="flex items-center gap-2 font-medium text-gray-700 hover:bg-gray-100 px-3 py-1.5 rounded-lg transition-colors text-sm">
          Meu Modelo 3.5 Pro <i class="fa-solid fa-chevron-down text-xs text-gray-400"></i>
        </button>
      </div>
      <div class="flex items-center gap-2">
        <button id="export-chat" class="p-2 text-gray-500 hover:bg-gray-100 rounded-lg" title="Exportar conversa">
          <i class="fa-solid fa-arrow-up-from-bracket"></i>
        </button>
        <button id="clear-chat" class="p-2 text-gray-500 hover:bg-gray-100 rounded-lg" title="Limpar conversa">
          <i class="fa-solid fa-trash"></i>
        </button>
      </div>
    </header>

    <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6 flex flex-col gap-6 pb-56 md:pb-52">
      <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center max-w-2xl mx-auto space-y-6 mt-10">
        <div class="w-16 h-16 rounded-2xl bg-claude-accent/10 flex items-center justify-center text-claude-accent text-3xl"><i class="fa-solid fa-sparkles"></i></div>
        <h1 class="text-3xl font-serif text-gray-800">Olá, <span id="welcome-name">Usuário</span></h1>
        <p class="text-gray-500 text-lg">Como posso ajudar você hoje?</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 w-full mt-8">
          <button data-suggestion="Me ajude a escrever um e-mail profissional" class="suggestion-btn p-4 border border-claude-border rounded-xl text-left hover:bg-gray-50 transition-colors text-sm text-gray-600 flex flex-col gap-2">
            <span class="font-medium text-gray-800"><i class="fa-regular fa-envelope text-claude-accent"></i> E-mail Profissional</span>
            Me ajude a escrever um e-mail...
          </button>
          <button data-suggestion="Quais são as tendências de tecnologia para 2026?" class="suggestion-btn p-4 border border-claude-border rounded-xl text-left hover:bg-gray-50 transition-colors text-sm text-gray-600 flex flex-col gap-2">
            <span class="font-medium text-gray-800"><i class="fa-solid fa-microchip text-claude-accent"></i> Tecnologia</span>
            Tendências para 2026...
          </button>
        </div>
      </div>
    </div>

    <div class="sticky bottom-0 w-full bg-gradient-to-t from-claude-bg via-claude-bg to-transparent pt-8 pb-[calc(0.75rem+env(safe-area-inset-bottom))] px-4 md:px-6 z-10">
      <div class="max-w-3xl mx-auto relative">
        <div class="border border-claude-border bg-white rounded-2xl shadow-sm focus-within:ring-1 focus-within:ring-claude-accent/50 focus-within:border-claude-accent/50 transition-all flex flex-col">
          <textarea id="user-input" rows="1" placeholder="Mensagem para a IA..." class="w-full max-h-48 resize-none bg-transparent outline-none p-4 text-gray-800 placeholder-gray-400 no-scrollbar"></textarea>
          <div class="px-3 pt-1 pb-2 text-xs text-gray-500 flex flex-wrap items-center gap-2 border-t border-claude-border/70">
            <span class="font-medium">Tempo de reflexão:</span>
            <select id="thinking-time" class="text-xs border border-claude-border rounded-lg px-2 py-1 bg-white text-gray-700 outline-none focus:ring-1 focus:ring-claude-accent/50">
              <option value="0">Sem espera extra</option>
              <option value="3000">3 segundos</option>
              <option value="5000" selected>5 segundos</option>
              <option value="8000">8 segundos</option>
              <option value="10000">10 segundos</option>
            </select>
            <span class="ml-auto text-[11px] text-gray-400">A IA usa esse tempo para caprichar na resposta.</span>
          </div>
          <div class="flex items-center justify-between px-3 py-2 text-gray-500">
            <div class="flex items-center gap-1">
              <button id="image-btn" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 hover:text-gray-800 transition" title="Anexar arquivo"><i class="fa-solid fa-paperclip"></i></button>
              <input id="file-input" type="file" accept="image/*" hidden>
              <button class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 hover:text-gray-800 transition" title="Pesquisar na Web"><i class="fa-solid fa-globe"></i></button>
            </div>
            <button id="send-btn" class="w-8 h-8 flex items-center justify-center rounded-lg bg-claude-accent text-white hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
              <i class="fa-solid fa-arrow-up"></i>
            </button>
          </div>
          <img id="preview" class="max-h-24 w-24 object-cover rounded-lg border border-claude-border mx-3 mb-3 hidden" alt="Prévia da imagem">
        </div>
        <p class="text-center text-xs text-gray-400 mt-3">A IA pode cometer erros. Considere verificar informações importantes.</p>
      </div>
    </div>
  </main>

  <script type="module">
    import { auth } from './js/firebase-init.js';
    import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

    const STORAGE_KEY = 'psyzon_conversations';
    const inputEl = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const chatContainer = document.getElementById('chat-container');
    const welcomeScreen = document.getElementById('welcome-screen');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const list = document.getElementById('conversation-list');
    const preview = document.getElementById('preview');
    const fileInput = document.getElementById('file-input');
    const thinkingSelect = document.getElementById('thinking-time');

    let mode = 'normal';
    let pendingImage = null;
    let conversations = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    let currentId = conversations[0]?.id || null;

    const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(conversations));
    const nowIso = () => new Date().toISOString();
    const findCurrent = () => conversations.find((c) => c.id === currentId);

    const ensureConversation = () => {
      if (!findCurrent()) {
        const c = { id: crypto.randomUUID(), title: 'Nova conversa', messages: [], createdAt: nowIso(), updatedAt: nowIso() };
        conversations.unshift(c);
        currentId = c.id;
        save();
      }
    };

    const escapeHTML = (str) => str.replace(/[&<>'"]/g, (tag) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag]));

    const autoResize = () => {
      inputEl.style.height = 'auto';
      inputEl.style.height = `${inputEl.scrollHeight}px`;
      if (!inputEl.value) inputEl.style.height = 'auto';
    };

    const toggleSidebar = () => {
      sidebar.classList.toggle('-translate-x-full');
      overlay.classList.toggle('hidden');
    };

    const getGroup = (d) => {
      const date = new Date(d);
      const today = new Date();
      const startToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const startDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const diff = Math.floor((startToday - startDate) / 86400000);
      if (diff === 0) return 'Hoje';
      if (diff === 1) return 'Ontem';
      if (diff <= 7) return 'Esta semana';
      return 'Anteriores';
    };

    const renderList = () => {
      const groups = {};
      conversations.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt)).forEach((c) => {
        const g = getGroup(c.updatedAt);
        groups[g] = groups[g] || [];
        groups[g].push(c);
      });
      list.innerHTML = '';
      Object.entries(groups).forEach(([group, items]) => {
        const h = document.createElement('div');
        h.className = 'text-xs font-semibold text-gray-500 mb-2 px-2 mt-4';
        h.textContent = group;
        list.appendChild(h);

        items.forEach((c) => {
          const row = document.createElement('button');
          row.className = `w-full text-left truncate px-3 py-2 rounded-lg text-sm ${c.id === currentId ? 'bg-black/5 font-medium' : 'hover:bg-black/5 text-gray-700'}`;
          row.textContent = c.title;
          row.addEventListener('click', () => { currentId = c.id; renderAll(); });
          list.appendChild(row);
        });
      });
    };

    const scrollToBottom = () => {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    };

    const appendMessage = (text, sender) => {
      const msgDiv = document.createElement('div');
      msgDiv.className = `flex gap-4 max-w-3xl mx-auto w-full group ${sender === 'user' ? 'justify-end' : ''}`;
      if (sender === 'user') {
        msgDiv.innerHTML = `<div class="bg-claude-userMsg px-5 py-3.5 rounded-2xl rounded-tr-sm text-gray-800 whitespace-pre-wrap max-w-[85%]">${escapeHTML(text)}</div>`;
      } else {
        msgDiv.innerHTML = `
          <div class="w-8 h-8 shrink-0 rounded-lg bg-white border border-gray-200 flex items-center justify-center text-claude-accent mt-1 shadow-sm"><i class="fa-solid fa-sparkles text-sm"></i></div>
          <div class="flex-1 text-gray-800 pt-1.5 leading-relaxed relative"><div class="ai-content whitespace-pre-wrap">${text}</div></div>`;
      }
      chatContainer.appendChild(msgDiv);
      scrollToBottom();
      return msgDiv;
    };

    const renderMessages = () => {
      const c = findCurrent();
      chatContainer.innerHTML = '';
      if (!c.messages.length) {
        welcomeScreen.style.display = 'flex';
        chatContainer.appendChild(welcomeScreen);
        return;
      }
      welcomeScreen.style.display = 'none';
      c.messages.forEach((m) => appendMessage(m.content || '', m.role === 'assistant' ? 'ai' : 'user'));
    };

    const renderAll = () => {
      ensureConversation();
      renderList();
      renderMessages();
    };

    const sendMessage = async () => {
      const text = inputEl.value.trim();
      if (!text && !pendingImage) return;

      const c = findCurrent();
      const userText = text || '[Imagem enviada]';
      c.messages.push({ role: 'user', content: userText });
      c.updatedAt = nowIso();
      if (c.title === 'Nova conversa' || !c.title) c.title = userText.slice(0, 40) || 'Nova conversa';
      const history = c.messages.slice(-20);
      const message = text;

      inputEl.value = '';
      autoResize();
      sendBtn.disabled = true;
      save();
      renderAll();

      const aiNode = appendMessage('<span class="typing-cursor"></span>', 'ai');
      const contentNode = aiNode.querySelector('.ai-content');

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message,
            mode,
            history,
            image: pendingImage,
            includeSiteContext: true,
            thinkingTimeMs: Number(thinkingSelect?.value || 0)
          })
        });
        const data = await response.json();
        const answer = data.content || data.error || 'Sem resposta.';
        c.messages.push({ role: 'assistant', content: answer });
        c.updatedAt = nowIso();
        save();
        contentNode.textContent = answer;
        renderAll();
      } catch (error) {
        const fail = '⚠️ Erro de conexão com a IA.';
        c.messages.push({ role: 'assistant', content: fail });
        c.updatedAt = nowIso();
        save();
        contentNode.textContent = fail;
        renderAll();
      }

      pendingImage = null;
      preview.classList.add('hidden');
      fileInput.value = '';
    };

    document.getElementById('toggle-sidebar').addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', toggleSidebar);
    document.getElementById('new-chat').addEventListener('click', () => {
      const c = { id: crypto.randomUUID(), title: 'Nova conversa', messages: [], createdAt: nowIso(), updatedAt: nowIso() };
      conversations.unshift(c);
      currentId = c.id;
      save();
      renderAll();
      if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) toggleSidebar();
    });

    document.getElementById('go-dashboard').addEventListener('click', () => { window.location.href = 'index.html'; });
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = 'login.html';
    });

    document.getElementById('clear-chat').addEventListener('click', () => {
      const c = findCurrent();
      c.messages = [];
      c.updatedAt = nowIso();
      save();
      renderAll();
    });

    document.getElementById('export-chat').addEventListener('click', () => {
      const c = findCurrent();
      const text = c.messages.map((m) => `${m.role === 'assistant' ? 'PSYZON AI' : 'Você'}: ${m.content}`).join('\n');
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `psyzon-ai-${c.id}.txt`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    document.querySelectorAll('.suggestion-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        inputEl.value = btn.dataset.suggestion || '';
        sendBtn.disabled = !inputEl.value.trim();
        inputEl.focus();
        autoResize();
      });
    });

    document.getElementById('image-btn').addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
      const file = fileInput.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const result = String(reader.result || '');
        preview.src = result;
        preview.classList.remove('hidden');
        pendingImage = { base64: result.split(',')[1], mimeType: file.type || 'image/png' };
      };
      reader.readAsDataURL(file);
    });

    inputEl.addEventListener('input', () => {
      sendBtn.disabled = inputEl.value.trim() === '' && !pendingImage;
      autoResize();
    });

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    sendBtn.addEventListener('click', sendMessage);

    onAuthStateChanged(auth, (user) => {
      const name = user?.displayName || user?.email?.split('@')[0] || 'Usuário';
      document.getElementById('user-name').textContent = name;
      document.getElementById('welcome-name').textContent = name;
      document.getElementById('user-initial').textContent = name.trim()[0]?.toUpperCase() || 'U';
      renderAll();
    });

    renderAll();
  </script>
</body>
</html>
