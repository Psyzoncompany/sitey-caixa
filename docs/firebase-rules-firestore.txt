rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwnUser(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    // Perfis do sistema (cada usuário só acessa o próprio documento)
    match /users/{uid} {
      allow read, write: if isOwnUser(uid);
    }

    // Ponte token -> oid (admin escreve, cliente lê apenas o documento específico)
    match /order_clients/{token} {
      allow get: if true;
      allow create, update: if isSignedIn();
      allow delete, list: if false;
    }

    // Snapshot público do pedido para a tela do cliente
    match /orders_public/{oid} {
      allow get: if true;
      allow create, update: if isSignedIn();
      allow delete, list: if false;
    }

    // Cabeçalho de feedback: apenas admin gerencia
    match /order_feedback/{token} {
      allow read, write: if isSignedIn();

      // Itens de feedback: cliente pode criar sem login, mas não pode listar/editar/remover
      match /items/{itemId} {
        allow create: if true;
        allow get, list, update, delete: if false;
      }
    }
  }
}
